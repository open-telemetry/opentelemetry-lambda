#!/bin/sh

export ORIG_HANDLER="$_HANDLER";
export _HANDLER="/opt/wrapper.otel_wrapper";


# Ensure Lambda can find gems shipped in the layer first
# Extract Ruby version from the runtime environment
if [ -n "$AWS_EXECUTION_ENV" ]; then
    # Extract version from AWS_EXECUTION_ENV (e.g., AWS_Lambda_ruby3.4)
    RUBY_VERSION_MAJOR_MINOR=$(echo "$AWS_EXECUTION_ENV" | grep -o 'ruby[0-9]\.[0-9]' | sed 's/ruby//')
fi

# Fallback: Try to detect from available directories
if [ -z "$RUBY_VERSION_MAJOR_MINOR" ]; then
    # Look for the ruby gems directory that exists
    for version in 3.4 3.3 3.2; do
        if [ -d "/opt/ruby/gems/${version}.0" ]; then
            RUBY_VERSION_MAJOR_MINOR="${version}"
            break
        fi
    done
fi

# Final fallback
if [ -z "$RUBY_VERSION_MAJOR_MINOR" ]; then
    RUBY_VERSION_MAJOR_MINOR="3.4"
fi

# For Ruby, we need the full version (e.g., 3.4.0)
export GEM_PATH="/opt/ruby/gems/${RUBY_VERSION_MAJOR_MINOR}.0:${GEM_PATH:-}"

if [ -z "${OTEL_SERVICE_NAME}" ]; then
    export OTEL_SERVICE_NAME="$AWS_LAMBDA_FUNCTION_NAME";
fi

# disable HTTP NET by default - otherwise, lambda runtime gets instrumented yielding noise
if [ -z "${OTEL_RUBY_INSTRUMENTATION_NET_HTTP_ENABLED}" ]; then
    export OTEL_RUBY_INSTRUMENTATION_NET_HTTP_ENABLED=false;
fi

export LAMBDA_RESOURCE_ATTRIBUTES="cloud.region=$AWS_REGION,cloud.provider=aws,faas.name=$AWS_LAMBDA_FUNCTION_NAME,faas.version=$AWS_LAMBDA_FUNCTION_VERSION,faas.instance=$AWS_LAMBDA_LOG_STREAM_NAME";
if [ -z "${OTEL_RESOURCE_ATTRIBUTES}" ]; then
    export OTEL_RESOURCE_ATTRIBUTES="$LAMBDA_RESOURCE_ATTRIBUTES";
else
    export OTEL_RESOURCE_ATTRIBUTES="$LAMBDA_RESOURCE_ATTRIBUTES,$OTEL_RESOURCE_ATTRIBUTES";
fi

exec "$@"
